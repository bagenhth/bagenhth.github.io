<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Spring In Action -- JDBC · Geek</title><meta name="description" content="Spring In Action -- JDBC - Bruce Lee"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://geek.com/atom.xml" title="Geek"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/bagenhth" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Spring In Action -- JDBC</h1><div class="post-info">2017年8月22日</div><div class="post-content"><p>　　以下内容节选自《Spring In Action》一书，描述了Spring对于JDBC的支持，以及一些Spring与JDBC操作之间的细节。<br><a id="more"></a></p>
<h2 id="1-直接使用JDBC操作数据库"><a href="#1-直接使用JDBC操作数据库" class="headerlink" title="1. 直接使用JDBC操作数据库"></a><em>1.</em> 直接使用JDBC操作数据库</h2><p>　　<strong>JDBC</strong>是Java与数据库之间进行沟通的标准方式，如果采用传统的方式，直接通过JDBC访问数据库并执行操作，那么你需要自己处理关于这一过程中的所有细节、琐事，例如下面是一段直接使用JDBC访问数据库的样板代码，你可以发现数十行代码仅仅是为了实现向数据库中插入一个用户对象(User)这一简单操作，冗长而繁琐。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL = <span class="string">"INSERT INTO USER (username, password, fullname) VALUES (?, ?, ?)"</span>;</div><div class="line">  <span class="keyword">private</span> DataSource dataSource;</div><div class="line">  </div><div class="line">  Connection conn = <span class="keyword">null</span>;</div><div class="line">  PreparedStatement stmt = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    conn = dataSource.getConnection();</div><div class="line">    stmt = conn.preparedStatement(SQL);</div><div class="line">    stmt.setString(<span class="number">1</span>, user.getUsername());</div><div class="line">    stmt.setString(<span class="number">2</span>, user.getPassword());</div><div class="line">    stmt.setString(<span class="number">3</span>, user.getFullName());</div><div class="line">  &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</div><div class="line">    <span class="comment">// 异常处理</span></div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) &#123;</div><div class="line">        stmt.close();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">        conn.close();</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</div><div class="line">      <span class="comment">// 异常处理</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　上面这段代码中，只有几句是真正用于执行数据插入的，但是由于JDBC要求你必须正确地管理连接和语句，所以你不得不处理过程中可能的异常，注意这个<strong>SQLException</strong>异常，你不仅不知道如何处理它（因为不知道具体的出错原因），而且还需要捕获它两次（插入操作以及关闭连接时），因此你需要手动执行很多的附加操作来解决这些问题，而这些细节通常与你关注的业务逻辑无关。<br>　　此外，这些建立连接、处理异常、关闭连接、释放资源的相同操作会在每一个数据操作方法里被执行一次，多余而浪费。
　　
　　</p>
<h2 id="2-使用Spring提供的JDBC-Template操作数据库"><a href="#2-使用Spring提供的JDBC-Template操作数据库" class="headerlink" title="2. 使用Spring提供的JDBC Template操作数据库"></a><em>2.</em> 使用Spring提供的JDBC Template操作数据库</h2><p>　　由于直接使用JDBC操作数据库有很多的样板代码，Spring提供了JDBC Template来简化JDBC代码，让我们只需要编写从数据库读取数据的必要代码。<br>　　Spring将数据访问的样板代码抽象到了模板类当中，Spring为JDBC提供了三个模板类供选择： </p>
<ul>
<li><strong>JdbcTemplate</strong> 最基本的JDBC模板，这个模板支持简单的JDBC数据库访问功能以及基于索引参数的查询</li>
<li><strong>Named</strong> 使用改模板类执行查询时可以将值以命名参数的形式绑定到SQL语句中，而不是简单的索引参数。 </li>
<li><del><strong>SimpleJdbcTemplate</strong> 已弃用</del></li>
</ul>
<h3 id="2-1-使用JdbcTemplate"><a href="#2-1-使用JdbcTemplate" class="headerlink" title="2.1 使用JdbcTemplate"></a><em>2.1</em> 使用JdbcTemplate</h3><p>　　为了让JdbcTemplate正常工作，需要为其提供数据源，简单的配置如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*# ApplicationContextConfig.java #*/</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * dev环境数据源</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> H2嵌入式数据源</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Profile</span>(<span class="string">"dev"</span>)</div><div class="line"><span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">EmbeddedDataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder()</div><div class="line">      .setType(EmbeddedDatabaseType.H2)</div><div class="line">      .addScript(<span class="string">"classpath:db_test/default.sql"</span>)</div><div class="line">      .build();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * qa环境数据源</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> DBCP2数据库连接池，封装MySql数据库</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Profile</span>(<span class="string">"qa"</span>)</div><div class="line"><span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">DBCP2DataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">  BasicDataSource dataSource = <span class="keyword">new</span> BasicDataSource();</div><div class="line">  dataSource.setDriverClassName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">  dataSource.setUrl(</div><div class="line">      <span class="string">"jdbc:mysql://localhost:3306/default?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8"</span></div><div class="line">  );</div><div class="line">  dataSource.setUsername(<span class="string">"root"</span>);</div><div class="line">  dataSource.setPassword(<span class="string">"root"</span>);</div><div class="line">  dataSource.setInitialSize(<span class="number">5</span>);</div><div class="line">  dataSource.setMaxTotal(<span class="number">10</span>);</div><div class="line">  <span class="keyword">return</span> dataSource;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * JdbcTemplate Bean</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> dataSource 数据源</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> JdbcTemplate Bean</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Bean</span>(<span class="string">"jdbcOperations"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　注意以上java config文件中使用了Spring的profile特性，使得可以在运行时切换不同的数据源。<br>　　<br>　　<br>　　一个简短的Domain类如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*# Student.java #*/</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Integer id;</div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> Integer age;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">short</span> gender;</div><div class="line">  </div><div class="line">  <span class="comment">// 省略getter、setter</span></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　对应的Repository接口实现类如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*# StudentRepositoryImpl.java #*/</span></div><div class="line"></div><div class="line"><span class="meta">@Repository</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">StudentRepository</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="keyword">private</span> JdbcOperations jdbcOperations;</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StudentRepositoryImpl</span><span class="params">(JdbcOperations jdbcOperations)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.jdbcOperations = jdbcOperations;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  </div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * 查询单个学生对象</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> id 学号</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> 学生对象</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAStudent</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">    String SQL = <span class="string">"SELECT ID, NAME, AGE, GENDER FROM STUDENT WHERE ID = ?"</span>;</div><div class="line">    <span class="keyword">return</span> jdbcOperations.queryForObject(SQL, <span class="keyword">this</span>::mapperStudent, id);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Student对象映射函数</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> rs 结果集</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> row 行号</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> 包装后的Student对象</span></div><div class="line"><span class="comment">   * <span class="doctag">@throws</span> SQLException</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">private</span> Student <span class="title">mapStudent</span><span class="params">(ResultSet rs, <span class="keyword">int</span> row)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Student student = <span class="keyword">new</span> Student();</div><div class="line">    student.setId(rs.getInt(<span class="string">"id"</span>));</div><div class="line">    student.setName(rs.getString(<span class="string">"name"</span>));</div><div class="line">    student.setAge(rs.getInt(<span class="string">"age"</span>));</div><div class="line">    student.setGender(rs.getShort(<span class="string">"gender"</span>));</div><div class="line">    <span class="keyword">return</span> student;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>P.S.</strong> 以上实现使用构造器注入<br><strong>P.S.S</strong> 上述实现中使用了JdbcOperations接口，它包含了JdbcTemplate所实现的所有方法，通过注入JdbcOperations，而不是具体的JdbcTemplate，可以保证StudentRepositoryImpl与JdbcTemplate的松散耦合。</p>
<h3 id="2-2-使用NamedParameterJdbcTemplate"><a href="#2-2-使用NamedParameterJdbcTemplate" class="headerlink" title="2.2 使用NamedParameterJdbcTemplate"></a><em>2.2</em> 使用NamedParameterJdbcTemplate</h3><p>　　Domain与Repository与上述相同，不再单独列出。NamedParameterJdbcTemplate提供了基于命名参数的SQL参数替换规则，可以不用关心参数值与占位符对应不上的情况。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*# StudentRepositoryImpl.java #*/</span></div><div class="line"></div><div class="line"><span class="meta">@Repository</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">StudentRepository</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> NamedParameterJdbcOperations namedParameterJdbcOperations;</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StudentRepositoryImpl</span><span class="params">(NamedParameterJdbcOperations namedParameterJdbcOperations)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.namedParameterJdbcOperations = namedParameterJdbcOperations;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * 更新学生实体对象</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> student 学生对象</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> 受影响的行数</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateStudent</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">    StringBuffer SQL = <span class="keyword">new</span> StringBuffer(<span class="string">"UPDATE STUDENT SET "</span>)</div><div class="line">        .append(<span class="string">"NAME = :name, "</span>)</div><div class="line">        .append(<span class="string">"AGE = :age, "</span>)</div><div class="line">        .append(<span class="string">"GENDER = :gender where ID = :id"</span>);</div><div class="line">    BeanPropertySqlParameterSource namedParameters = <span class="keyword">new</span> BeanPropertySqlParameterSource(student);</div><div class="line">    <span class="keyword">return</span> namedParameterJdbcOperations.update(SQL.toString(), namedParameters);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Student对象映射函数</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> rs 结果集</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> row 行号</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> 包装后的Student对象</span></div><div class="line"><span class="comment">   * <span class="doctag">@throws</span> SQLException</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">private</span> Student <span class="title">mapStudent</span><span class="params">(ResultSet rs, <span class="keyword">int</span> row)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Student student = <span class="keyword">new</span> Student();</div><div class="line">    student.setId(rs.getInt(<span class="string">"id"</span>));</div><div class="line">    student.setName(rs.getString(<span class="string">"name"</span>));</div><div class="line">    student.setAge(rs.getInt(<span class="string">"age"</span>));</div><div class="line">    student.setGender(rs.getShort(<span class="string">"gender"</span>));</div><div class="line">    <span class="keyword">return</span> student;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/07/02/JavaScript数组操作（遗漏点）/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://geek.com">Bruce Lee</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>